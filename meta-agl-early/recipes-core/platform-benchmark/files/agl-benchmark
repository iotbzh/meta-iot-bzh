#!/bin/bash

vMAJOR=0
vMINOR=2

VERSION=${vMAJOR}.${vMINOR}

source /etc/platform-info/hardware

SCRIPT=$(basename $BASH_SOURCE)

rd='\e[0;31m'
gr='\e[0;32m'
yl='\e[0;33m'
bl='\e[0;34m'
nc='\e[0m' # no color

CPU_LOG_FILE=/tmp/agl-benchmark.testcpu.log
RAM_LOG_FILE=/tmp/agl-benchmark.testram.log
GPU_LOG_FILE=/tmp/agl-benchmark.testgpu.log

trap "exit" INT TERM ERR
trap "kill 0" EXIT

function usage() {
	cat <<EOF >&2
Usage: $SCRIPT [options]

Options:
   -v|--verbose
      show all output messages
      default: off
   -h|--help
      get this help

EOF
	exit 1
}

TEMP=$(getopt -o svh -l show-details,verbose,help -n $SCRIPT -- "$@")
[[ $? != 0 ]] && usage
eval set -- "$TEMP"

#default options values
VERBOSE=0
SHOW_DETAILS=0

while true; do
	case "$1" in
		-s|--show-details) SHOW_DETAILS=1; shift ;;
		-v|--verbose) VERBOSE=1; shift ;;
		-h|--help) HELP=1; shift ;;
		--) shift; break;;
		*) error "Internal error"; exit 1;;
	esac
done

[[ "$HELP" == 1 ]] && usage

clean()
{
	if [ -f $CPU_LOG_FILE ]
	then rm $CPU_LOG_FILE
	fi

	if [ -f $RAM_LOG_FILE ]
	then rm $RAM_LOG_FILE
	fi

	if [ -f $GPU_LOG_FILE ]
	then rm $GPU_LOG_FILE
	fi
}
sys_info()
{
	#Start by identifying general system information

	echo -en " Scanning hardware..."

	CPU_NAME=$HW_SOC_VENDOR" "$HW_SOC_FAMILY" "$HW_SOC_ID
	CPU_NB_ONLINE_CORE=$(cat /proc/cpuinfo | grep -i "^processor" | wc -l)
	CPU_FREQ=$HW_CPU_FREQ_MHZ
	CPU_CACHE_SIZE=$HW_CPU_CACHE_KB
	CPU_BOGO_MIPS=$(cat /proc/cpuinfo | grep -i -m1 "^bogomips" | awk -F": " '{print $2}')

	if [ "$HW_CPU_ARCH" == "aarch64" ]
	then
		RAM_NAME="N/A"
		MEM_SIZE=$HW_MEMORY_TOTAL_MB
		MEM_SPEED="N/A"
	else
		dmidecode --type 17 &> /tmp/raminfo.log
		RAM_BRAND=$(grep -i -m1 "Manufacturer" /tmp/raminfo.log | awk -F": " '{print $2}')
		RAM_PN=$(grep -i -m1 "Part Number" /tmp/raminfo.log | awk -F": " '{print $2}')
		RAM_NAME=$RAM_BRAND" "$RAM_PN
		MEM_SIZE=$HW_MEMORY_TOTAL_MB
		MEM_SPEED=$(grep -i -m1 "Speed" /tmp/raminfo.log | awk -F": " '{print $2}')
	fi

	if [[ "$SHOW_DETAILS" == 1 ]]
	then
		echo -en "\r Hardware information :\n"
		echo -e " * CPU : $CPU_NAME"
		echo -e "   - Arch  : $HW_CPU_ARCH"
		echo -e "   - Cores : $CPU_NB_ONLINE_CORE/$HW_CPU_COUNT"
		echo -e "   - Freq  : $CPU_FREQ MHz"
		echo -e "   - Cache : $CPU_CACHE_SIZE KB"
		echo -e "   - Bogo  : $CPU_BOGO_MIPS MIPS"

		echo -e " * RAM : $RAM_NAME"
		echo -e "   - Size  : $MEM_SIZE MB"
		echo -e "   - Speed : $MEM_SPEED"

		echo -e " * GPU : $HW_GPU_NAME"
# 		echo -e "   - Freq  : $GPU_FREQ MHz"
		echo    ""
	else
		echo -en " OK.\n\n"
	fi
}

print_result()
{
	if [ $1 == "CPU" ]
	then
		CPU_SCORE=$(grep "] cpu" $CPU_LOG_FILE | awk -F"] cpu" '{print $2}' | sed -e 's/^[ \t]*//' | awk -F" " '{print $5}' | cut -d'.' -f1)
		echo -en "\r * CPU Results :  \n"
		echo -e "   - Stress-ng : $gr$CPU_SCORE$nc"

	elif [ $1 == "RAM" ]
	then
		RAM_SCORE=$(grep "] vm" $RAM_LOG_FILE | awk -F"] vm" '{print $2}' | sed -e 's/^[ \t]*//' | awk -F" " '{print $5}' | cut -d'.' -f1)
		echo -en "\r * RAM Results :  \n"
		echo -e "   - Stress-ng : $gr$RAM_SCORE$nc"

	elif [ $1 == "GPU" ]
	then
		GPU_SCORE=$(grep "glmark2 Score" $GPU_LOG_FILE | awk -F": " '{print $2}' | cut -d' ' -f1)
		echo -en "\r * GPU Results :  \n"
		echo -e "   - glmark2   : $gr$GPU_SCORE$nc"
	fi
}

launch_all_tests()
{
	echo " Start benchmarking..."

	#CPU benchmarking
	if [ $VERBOSE -eq 1 ]
	then
		tail -f $CPU_LOG_FILE &
	fi
	echo -en " * CPU Testing..."
	stress-ng --cpu $CPU_NB_ONLINE_CORE --cpu-method fft --metrics-brief --timeout 5s &> $CPU_LOG_FILE
	print_result "CPU"

	#RAM benchmarking
	if [ $VERBOSE -eq 1 ]
	then
		tail -f $RAM_LOG_FILE &
	fi
	echo -en " * RAM Testing..."
	stress-ng --vm 1 --vm-bytes 128M --metrics-brief --timeout 5s &> $RAM_LOG_FILE
	print_result "RAM"

	#GPU benchmarking
	if [ $VERBOSE -eq 1 ]
	then
		tail -f $GPU_LOG_FILE &
	fi
	echo -en " * GPU Testing..."
	glmark2-es2-wayland --off-screen &> $GPU_LOG_FILE
	print_result "GPU"

	echo ""

	AGL_SCORE=$(($CPU_SCORE*45+$RAM_SCORE*5+$GPU_SCORE*50))
	AGL_SCORE=$(($AGL_SCORE/100))
}

###############################################################################################


echo -e "$rd######################################"
echo -e "#$nc   AGL Benchmarking script - v$VERSION   $rd#"
echo -e "$rd######################################$nc\n"


clean

sys_info

launch_all_tests


echo -e "$rd######################################"
printf "#$nc Your AGL Benchmarking score: $gr%5s $rd#\n" $AGL_SCORE
echo -e "$rd######################################$nc\n"

exit 0
